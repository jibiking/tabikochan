<style>
#gmap {
  height: 800px;
  width: 1000px;
}
</style>

</head>

<body>
  <div id="gmap"></div><!-- 地図を表示する領域 -->

  <h1>Result</h1>
  <p>Start Location:<br>
    <%= @start_location %>
  </p>
  <p>End Location:<br>
    <%= @end_location %>
  </p>
  <p>Waypoint:<br>
    <% @waypoint.each do |waypoint| %>
      <%= waypoint %><br>
    <% end %>
  </p>


  <script>
    function initMap() {
      // 地図を生成して表示
      var map = new google.maps.Map(document.getElementById("gmap"), {
        zoom: 13,
        center: '筑波山山頂', // マップ中央をスタート地点に設定
        mapTypeId: "roadmap"
      });

      //DirectionsService のオブジェクトを生成
      var directionsService = new google.maps.DirectionsService();

      //DirectionsRenderer のオブジェクトを生成
      var directionsRenderer = new google.maps.DirectionsRenderer();

      //directionsRenderer と地図を紐付け
      directionsRenderer.setMap(map);

      // 経由地の配列を生成（最大8個）
      var wayPoints = new Array();
      wayPoints.push({location: 'つくば駅'});
      wayPoints.push({location: '松代公園'});
      wayPoints.push({location: 'つくば牡丹園'});


      // ルートを取得するリクエスト
      var request = {
        origin: '筑波山山頂',      // スタート地点
        destination: 'イオンモールつくば',   // ゴール地点
        avoidHighways: true, // 高速は利用しない
        travelMode: google.maps.TravelMode.DRIVING, // 車モード
    		optimizeWaypoints: true, // 最適化を有効
		    waypoints: wayPoints // 経由地
      };

      //DirectionsService のオブジェクトのメソッド route() にリクエストを渡し、
      //コールバック関数で結果を setDirections(result) で directionsRenderer にセットして表示
      directionsService.route(request, function(result, status) {
        //ステータスがOKの場合、
        if (status === 'OK') {
          directionsRenderer.setDirections(result); //取得したルート（結果：result）をセット
          var legs = result.routes[0].legs;

          var dis = 0;
          var sec = 0;
          var count_route = 'A'.charCodeAt(0); // 'A' の文字コードを取得

          // 経由地間の距離・時間を表示
          legs.forEach(function(val) {
            sec += val.duration.value;
            dis += val.distance.value;

            // ルートを整形
            var routeLetter = String.fromCharCode(count_route) + '-' + String.fromCharCode(count_route + 1);
            count_route++; // 文字コードを1つ増やす

            console.log(routeLetter + ", " + val.distance.text + ", " + val.duration.text);
            });

          var distanceInKm = (dis / 1000).toFixed(1);

          var minutes = sec / 60;
          var hours = Math.floor(minutes / 60);
          minutes = Math.round(minutes % 60);

          console.log("距離：" + distanceInKm + "km, 時間：" + hours + "時間" + minutes + "分");
        }else{
          alert("取得できませんでした：" + status);
        }
      });
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiHipELuIh7hSMRxi92Fngg7DkJN2jf4s&callback=initMap" async defer></script>
</body>